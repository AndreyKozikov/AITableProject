# Отчет: Алгоритм восстановления структуры таблицы в PaddleOCR и PPStructure V3

## Обзор

PaddleOCR с модулем PPStructure V3 представляет собой комплексную систему для анализа и восстановления структуры таблиц из изображений. Алгоритм использует многоступенчатый подход, сочетающий глубокое обучение, компьютерное зрение и оптическое распознавание символов (OCR).

## Архитектура системы

### Основные компоненты:
1. **Layout Analysis** - анализ макета документа
2. **Table Detection** - обнаружение таблиц
3. **Table Classification** - классификация типов таблиц
4. **Cell Detection** - обнаружение ячеек
5. **Structure Recognition** - распознавание структуры
6. **Text Recognition** - распознавание текста
7. **Post-processing** - постобработка и восстановление

## Подробный алгоритм восстановления структуры таблицы

### Этап 1: Предобработка изображения

```
Вход: Изображение документа
↓
1. Загрузка и конвертация в RGB формат
2. Коррекция ориентации (если необходимо)
3. Нормализация размеров и контраста
4. Подготовка для дальнейшей обработки
```

**Технические детали:**
- Используется стандартная предобработка изображений
- Применяются методы коррекции искажений
- Обеспечивается совместимость с моделями глубокого обучения

### Этап 2: Анализ макета документа (Layout Analysis)

```
Обработанное изображение
↓
Модель: PicoDet_layout_1x_table
↓
Результат: Координаты областей (текст, таблицы, изображения)
```

**Алгоритм:**
1. **Детекция областей**: Используется модель PicoDet на основе YOLO для определения различных областей документа
2. **Классификация областей**: Каждая обнаруженная область классифицируется как текст, таблица, изображение или список
3. **Фильтрация таблиц**: Выделяются только области, содержащие таблицы

**Модель PicoDet_layout_1x_table:**
- Точность: 97.5%
- Время GPU: 9.57 / 6.63 мс
- Размер: 7.4 МБ
- Основана на PicoDet-1x, обучена на специальном датасете

### Этап 3: Обнаружение и классификация таблиц

```
Области таблиц
↓
Модель классификации: PP-LCNet_x1_0_table_cls
↓
Результат: Тип таблицы (wired/wireless)
```

**Классификация таблиц:**
1. **Wired Tables** (таблицы с линиями):
   - Четко определенные границы ячеек
   - Видимые горизонтальные и вертикальные линии
   - Более простая структура для анализа

2. **Wireless Tables** (таблицы без линий):
   - Отсутствие видимых границ
   - Структура определяется по выравниванию текста
   - Более сложная для анализа

**Модель PP-LCNet_x1_0_table_cls:**
- Точность: 94.2% (Top1)
- Время GPU: 2.62 / 0.60 мс
- Размер: 6.6 МБ

### Этап 4: Обнаружение ячеек (Cell Detection)

```
Классифицированная таблица
↓
Модель: RT-DETR-L_wired/wireless_table_cell_det
↓
Результат: Bounding boxes для каждой ячейки
```

**Алгоритм обнаружения ячеек:**
1. **Для Wired таблиц**: 
   - Анализ пересечений линий
   - Морфологические операции для выделения границ
   - Определение прямоугольных областей

2. **Для Wireless таблиц**:
   - Анализ выравнивания текста
   - Кластеризация текстовых блоков
   - Определение границ по пространственному распределению

**Модели RT-DETR-L:**
- **mAP**: 82.7%
- **Время GPU**: 33.47 / 27.02 мс
- **Размер**: 124 МБ
- **Особенности**: Основаны на DETR (Detection Transformer)

### Этап 5: Распознавание структуры таблицы (Structure Recognition)

```
Обнаруженные ячейки + исходное изображение
↓
Модели: SLANet / SLANet_plus / SLANeXt_wired/wireless
↓
Результат: Структурная информация (строки, столбцы, объединения)
```

#### Модели структуры:

**SLANet:**
- Точность: 59.52%
- Время GPU: 23.96 / 21.75 мс
- Размер: 6.9 МБ
- Архитектура: PP-LCNet + CSP-PAN + SLA Head

**SLANet_plus:**
- Точность: 63.69%
- Время GPU: 23.43 / 22.16 мс
- Размер: 6.9 МБ
- Улучшения: Лучше работает с wireless таблицами

**SLANeXt (новейшая версия):**
- Точность: 69.65%
- Время GPU: 85.92 / 85.92 мс
- Размер: 351 МБ
- Специализация: Отдельные модели для wired и wireless таблиц

#### Алгоритм распознавания структуры:

1. **Извлечение признаков**:
   ```
   Изображение → PP-LCNet backbone → Многоуровневые признаки
   ```

2. **Слияние признаков**:
   ```
   CSP-PAN модуль → Объединение низкоуровневых и высокоуровневых признаков
   ```

3. **Декодирование структуры**:
   ```
   SLA Head → Предсказание:
   - Горизонтальные линии (rows)
   - Вертикальные линии (columns) 
   - Объединенные ячейки (merged cells)
   ```

### Этап 6: Распознавание текста в ячейках

```
Координаты ячеек + исходное изображение
↓
Модель: PP-OCRv3
↓
Результат: Текстовое содержимое каждой ячейки
```

**Алгоритм OCR:**
1. **Обрезка ячеек**: Извлечение областей ячеек из исходного изображения
2. **Предобработка**: Нормализация, бинаризация, коррекция наклона
3. **Детекция текста**: Определение областей текста в ячейке
4. **Распознавание**: Извлечение текста из каждой области

### Этап 7: Постобработка и восстановление структуры

Это ключевой этап, где происходит объединение всех данных в финальную структуру таблицы.

#### 7.1 Анализ объединенных ячеек

```
Структурная информация + координаты ячеек
↓
Алгоритм анализа объединений:
```



2. **Обнаружение объединений по столбцам**:
   ```python
   for each_column:
       cells_in_col = get_cells_in_column(column)
       for i, cell in enumerate(cells_in_col):
           if cell.horizontal_span > 1:
               # Ячейка объединена по горизонтали
               mark_merged_cells(cell, horizontal_span=cell.horizontal_span)
   ```

#### 7.2 Восстановление сетки таблицы

```
Обнаруженные ячейки + структурная информация
↓
Алгоритм восстановления сетки:
```

1. **Определение границ строк**:
   ```python
   # Группировка ячеек по строкам
   rows = []
   for cell in cells:
       row_index = find_row_for_cell(cell, existing_rows)
       if row_index == -1:
           # Создать новую строку
           rows.append([cell])
       else:
           rows[row_index].append(cell)
   ```

2. **Определение границ столбцов**:
   ```python
   # Группировка ячеек по столбцам
   columns = []
   for cell in cells:
       col_index = find_column_for_cell(cell, existing_columns)
       if col_index == -1:
           # Создать новый столбец
           columns.append([cell])
       else:
           columns[col_index].append(cell)
   ```

3. **Обработка многострочного текста**:
   ```python
   for cell in cells:
       if cell.has_multiline_text():
           # Объединить текстовые блоки в ячейке
           cell.text = merge_text_blocks(cell.text_blocks)
           cell.row_span = calculate_row_span(cell)
   ```

#### 7.3 Генерация финальной структуры

```
Восстановленная сетка + текстовое содержимое
↓
Алгоритм генерации:
```

1. **Создание HTML структуры**:
   ```python
   html_table = create_html_table(rows, columns, merged_cells)
   for row in rows:
       html_row = create_html_row()
       for cell in row:
           if cell.is_merged():
               html_cell = create_html_cell(
                   text=cell.text,
                   rowspan=cell.row_span,
                   colspan=cell.col_span
               )
           else:
               html_cell = create_html_cell(text=cell.text)
           html_row.append(html_cell)
       html_table.append(html_row)
   ```

2. **Создание Excel структуры**:
   ```python
   excel_sheet = create_excel_sheet()
   for row_idx, row in enumerate(rows):
       for col_idx, cell in enumerate(row):
           excel_sheet.cell(row_idx + 1, col_idx + 1, cell.text)
           if cell.is_merged():
               excel_sheet.merge_cells(
                   start_row=row_idx + 1,
                   end_row=row_idx + cell.row_span,
                   start_column=col_idx + 1,
                   end_column=col_idx + cell.col_span
               )
   ```

## Ключевые особенности алгоритма

### 1. Адаптивность к типам таблиц
- **Wired таблицы**: Использует анализ линий и пересечений
- **Wireless таблицы**: Использует анализ выравнивания и пространственного распределения

### 2. Обработка сложных случаев
- **Объединенные ячейки**: Автоматическое определение rowspan и colspan
- **Многострочный текст**: Объединение текстовых блоков в одной ячейке
- **Поворот текста**: Коррекция ориентации текста в ячейках

### 3. Многоуровневая архитектура
- **Модульность**: Каждый этап может быть настроен независимо
- **Масштабируемость**: Поддержка различных размеров и сложности таблиц
- **Точность**: Специализированные модели для каждого типа задач

## Производительность

### Временные характеристики (на GPU Tesla T4):
- **Layout Analysis**: ~10 мс
- **Table Classification**: ~3 мс  
- **Cell Detection**: ~30 мс
- **Structure Recognition**: ~25-85 мс (зависит от модели)
- **Text Recognition**: ~50-100 мс
- **Post-processing**: ~5-10 мс

**Общее время**: ~120-240 мс на таблицу

### Точность:
- **SLANet**: 59.52%
- **SLANet_plus**: 63.69%
- **SLANeXt**: 69.65%

## Заключение

Алгоритм восстановления структуры таблицы в PaddleOCR и PPStructure V3 представляет собой сложную многоступенчатую систему, которая эффективно решает задачу извлечения структурированных данных из изображений таблиц. Ключевыми преимуществами являются:

1. **Высокая точность** благодаря специализированным моделям
2. **Адаптивность** к различным типам таблиц
3. **Обработка сложных случаев** (объединенные ячейки, многострочный текст)
4. **Модульная архитектура** для легкой настройки и улучшения
5. **Производительность** для практического использования

Алгоритм успешно применяется в различных областях, включая обработку документов, автоматизацию ввода данных и анализ структурированной информации.
1. **Обнаружение объединений по строкам**:
   ```python
   for each_row:
       cells_in_row = get_cells_in_row(row)
       for i, cell in enumerate(cells_in_row):
           if cell.vertical_span > 1:
               # Ячейка объединена по вертикали
               mark_merged_cells(cell, vertical_span=cell.vertical_span)
   ```