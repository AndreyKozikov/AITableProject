# Архитектура AITableProject

## Общая архитектура системы

```
┌─────────────────────────────────────────────────────────────────┐
│                       Уровень представления                       │
│                    (Presentation Layer)                           │
│  ┌───────────────────────────────────────────────────────────┐   │
│  │         Streamlit Web Application                         │   │
│  │  - Drag & Drop загрузка файлов                            │   │
│  │  - Выбор AI модели                                        │   │
│  │  - Настройки обработки                                    │   │
│  │  - Отображение результатов                                │   │
│  │  - Скачивание Excel                                       │   │
│  └───────────────────────────────────────────────────────────┘   │
└────────────────────────────┬────────────────────────────────────┘
                             │ HTTP/Session
┌────────────────────────────▼────────────────────────────────────┐
│                    Уровень бизнес-логики                         │
│                     (Business Layer)                             │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              process_files (Orchestrator)                │   │
│  │  - Определение типа файла                                │   │
│  │  - Выбор парсера из Registry                             │   │
│  │  - Координация AI моделей                                │   │
│  │  - Генерация результатов                                 │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
│  ┌────────────────┐  ┌──────────────┐  ┌─────────────────┐     │
│  │   Parsers      │  │   Mappers    │  │   Utilities     │     │
│  │   Registry     │  │   (AI/ML)    │  │   (Helpers)     │     │
│  └────────────────┘  └──────────────┘  └─────────────────┘     │
└────────────────────────────┬────────────────────────────────────┘
                             │
┌────────────────────────────▼────────────────────────────────────┐
│                      Уровень данных                              │
│                       (Data Layer)                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌─────────────┐     │
│  │  inbox/  │  │ parsing_ │  │   out/   │  │   logs/     │     │
│  │  (input) │  │  files/  │  │ (output) │  │  (logging)  │     │
│  └──────────┘  └──────────┘  └──────────┘  └─────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

---

## Архитектура парсеров (Parser Architecture)

```
┌─────────────────────────────────────────────────────────────┐
│                    Parser Registry                           │
│         (Динамический выбор парсера по типу файла)           │
└─────────────────────┬───────────────────────────────────────┘
                      │
      ┌───────────────┼───────────────┬──────────────┐
      │               │               │              │
┌─────▼─────┐   ┌────▼────┐   ┌──────▼──┐   ┌──────▼──────┐
│   Image   │   │   PDF   │   │  Excel  │   │    DOCX     │
│  Parser   │   │ Parser  │   │ Parser  │   │   Parser    │
└─────┬─────┘   └────┬────┘   └────┬────┘   └──────┬──────┘
      │              │              │               │
      │              │              │               │
┌─────▼──────────────▼──────────────▼───────────────▼──────┐
│              Common Parser Interface                      │
│  - parse(file_path) -> DataFrame                          │
│  - validate_file(file_path) -> bool                       │
│  - extract_tables() -> List[DataFrame]                    │
└───────────────────────────────────────────────────────────┘
```

### Процесс обработки изображений

```
Изображение (JPG/PNG)
    │
    ▼
┌─────────────────────────────────┐
│  Image Preprocessor             │
│  1. Коррекция перспективы       │
│  2. Улучшение контрастности     │
│  3. Бинаризация                 │
│  4. Удаление шумов              │
│  5. Нормализация размера        │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  PaddleOCR PPStructure          │
│  1. Определение областей        │
│  2. Распознавание текста (OCR)  │
│  3. Анализ структуры таблицы    │
│  4. Извлечение ячеек            │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  OCR Postprocessor              │
│  1. Исправление опечаток        │
│  2. Морфологический анализ      │
│  3. Fuzzy matching              │
│  4. Нормализация Unicode        │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  Table Reconstruction           │
│  (reconstruct_table_from_ocr)   │
│  1. Детекция границ столбцов    │
│     (_detect_table_columns)     │
│  2. Объединение OCR по ячейкам  │
│     (_merge_ocr_blocks_by_cells)│
│     - Сопоставление по центру   │
│     - Сопоставление по IoU      │
│     - Группировка по строкам    │
│  3. Распределение по столбцам   │
│  4. Формирование строк таблицы  │
│  5. Создание DataFrame          │
└────────────┬────────────────────┘
             │
             ▼
        DataFrame
```

---

## Архитектура AI-моделей (Mapper Architecture)

```
┌──────────────────────────────────────────────────────────────┐
│                   Mapper Orchestrator                         │
│               (mapper_structured function)                    │
└────────────────────────┬─────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┬───────────────────┐
        │                │                │                   │
   ┌────▼─────┐    ┌────▼─────┐    ┌────▼─────┐    ┌────────▼────────┐
   │  Qwen 3  │    │  Qwen 2  │    │ LLaMA 2  │    │  OpenAI GPT     │
   │   Local  │    │   VL     │    │  Local   │    │    Cloud        │
   └────┬─────┘    └────┬─────┘    └────┬─────┘    └────────┬────────┘
        │               │               │                    │
        └───────────────┴───────────────┴────────────────────┘
                                │
                                ▼
        ┌───────────────────────────────────────────────────┐
        │         Structured Output Validation              │
        │              (Pydantic Models)                    │
        │  - Схема таблицы                                  │
        │  - Валидация типов данных                         │
        │  - Проверка структуры                             │
        └───────────────────┬───────────────────────────────┘
                            │
                            ▼
                   Structured DataFrame
```

### Процесс работы с AI-моделями

```
Сырые данные (OCR/Text)
    │
    ▼
┌─────────────────────────────────┐
│  Prompt Template Formation      │
│  - Контекст задачи              │
│  - Примеры (few-shot)           │
│  - Схема вывода (Pydantic)      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  Model Selection                │
│  - remote_model? → OpenAI       │
│  - local_model → Qwen/LLaMA     │
│  - vision? → Qwen2 VL           │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  Model Inference                │
│  - Токенизация                  │
│  - Генерация                    │
│  - Декодирование                │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│  Output Parsing & Validation    │
│  - JSON парсинг                 │
│  - Pydantic валидация           │
│  - Извлечение данных            │
└────────────┬────────────────────┘
             │
             ▼
   Structured Table Data
```

---

## Поток данных (Data Flow)

```
1. Загрузка файла
   User → [Streamlit] → inbox/
                            │
2. Определение типа         │
   [process_files] ← ───────┘
         │
         ▼
3. Выбор парсера
   [Parser Registry] → [Specific Parser]
                            │
4. Извлечение данных        │
   [Parser] → parsing_files/ (JSON)
                            │
5. AI обработка             │
   [Mapper] ← ──────────────┘
      │
      ▼
6. Структурирование
   [Pydantic Models] → DataFrame
                            │
7. Сохранение результата    │
   [Excel Writer] → out/result.xlsx
                            │
8. Отображение              │
   [Streamlit] ← ───────────┘
      │
      ▼
   User (Download)
```

---

## Модульная структура кода

```
src/
├── parsers/              # Извлечение данных из документов
│   ├── __init__.py       # Инициализация модуля
│   ├── img_parser.py     # Обработка изображений (OCR)
│   ├── pdf_parser.py     # Парсинг PDF
│   ├── excel_parser.py   # Обработка Excel
│   ├── docx_parser.py    # Извлечение из DOCX
│   ├── txt_parser.py     # Текстовые файлы
│   ├── openai_parser.py  # Парсинг через OpenAI API
│   └── catalogue_parser.py # Специализированный парсер
│
├── mapper/               # AI-модели для структурирования
│   ├── __init__.py
│   ├── mapper.py         # Главный оркестратор
│   ├── ask_qwen3.py      # Qwen 3 модель
│   ├── ask_qwen3_so.py   # Qwen 3 Structured Output
│   ├── ask_qwen2.py      # Qwen 2 Vision-Language
│   └── ask_llama2.py     # LLaMA 2 модель
│
├── utils/                # Утилиты и вспомогательные модули
│   ├── __init__.py
│   ├── config.py         # Конфигурация приложения
│   ├── logging_config.py # Настройка логирования
│   ├── process_files.py  # Оркестратор обработки
│   ├── preprocess_image.py # Предобработка изображений
│   ├── image_preprocessor.py # Дополнительная обработка
│   ├── ocr_postprocessor.py # Постобработка OCR
│   ├── df_utils.py       # Работа с DataFrame (885 строк)
│   │                     # - Семантическое определение заголовков
│   │                     # - Реконструкция таблиц с IoU
│   │                     # - Группировка текстовых блоков
│   │                     # - Детекция границ столбцов
│   └── registry.py       # Система регистрации парсеров
│
├── app/                  # Веб-приложение
│   ├── enhanced_app.py   # Главное Streamlit приложение
│   ├── static/           # CSS, JS, изображения
│   │   └── styles.css    # Стили интерфейса
│   └── templates/        # HTML шаблоны компонентов
│       ├── template_loader.py
│       ├── header.html
│       ├── upload_card.html
│       ├── file_item.html
│       ├── file_list.html
│       ├── progress_tracker.html
│       └── results_display.html
│
├── learning/             # Обучение и fine-tuning моделей
│   ├── xport_data.py     # Экспорт JSON → Excel для обучения
│   │                     # - Создание Excel с листами INPUT + эталоны
│   │                     # - Автоподстройка ширины столбцов
│   │                     # - Массовая обработка JSON файлов
│   ├── datasets/         # Подготовка данных (Excel файлы)
│   ├── qwen-finetuned/   # Обученная модель
│   ├── qwen-lora-adapters/ # LoRA адаптеры
│   └── *.ipynb           # Jupyter ноутбуки
│
└── main.py               # Точка входа в приложение
```

---

## Паттерны проектирования

### 1. Registry Pattern (Парсеры)
```python
# Регистрация парсера
@register_parser("pdf")
def parse_pdf(file_path):
    ...

# Использование
parser = PARSERS.get(file_extension)
result = parser(file_path)
```

### 2. Strategy Pattern (AI Models)
```python
# Выбор стратегии обработки
if remote_model:
    strategy = OpenAIStrategy()
else:
    strategy = LocalModelStrategy()

result = strategy.process(data)
```

### 3. Template Method Pattern (Parsers)
```python
class BaseParser:
    def parse(self, file_path):
        self.validate()      # Шаг 1
        data = self.extract() # Шаг 2
        return self.clean(data) # Шаг 3
```

### 4. Factory Pattern (Model Creation)
```python
def create_model(model_type):
    if model_type == "qwen3":
        return Qwen3Model()
    elif model_type == "llama2":
        return LLaMA2Model()
```

---

## Конфигурация и настройки

```
config/
├── logging_config.json           # Конфигурация логирования
│   ├── formatters                # Форматы логов
│   ├── handlers                  # Обработчики (файл, консоль)
│   └── loggers                   # Логгеры модулей
│
└── preprocess_image_config.yaml  # Параметры обработки изображений
    ├── binarization              # Настройки бинаризации
    ├── noise_removal             # Удаление шумов
    └── contrast_enhancement      # Улучшение контраста
```

---

## Система логирования

```
┌───────────────────────────────────────┐
│        Application Code               │
│  logger = get_logger(__name__)        │
│  logger.info("Processing file...")    │
└─────────────┬─────────────────────────┘
              │
              ▼
┌───────────────────────────────────────┐
│     Logging Configuration             │
│  (config/logging_config.json)         │
└──────┬────────────────────┬───────────┘
       │                    │
       ▼                    ▼
┌─────────────┐      ┌─────────────┐
│ File Handler│      │Console      │
│             │      │Handler      │
└──────┬──────┘      └──────┬──────┘
       │                    │
       ▼                    ▼
  logs/app.log         stdout
  logs/daily.log       (Terminal)
  (with rotation)
```

---

## Обработка ошибок (Error Handling)

```
┌─────────────────────────────────────┐
│         Try-Catch Blocks            │
│  - Parser level                     │
│  - Mapper level                     │
│  - Application level                │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│         Error Logging               │
│  logger.error(f"Error: {e}")        │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│      User Notification              │
│  st.error("Ошибка обработки")       │
└─────────────────────────────────────┘
```

---

## Масштабируемость и расширяемость

### Добавление нового парсера
1. Создать файл `src/parsers/new_parser.py`
2. Реализовать функцию парсинга
3. Декорировать `@register_parser("new_format")`
4. Готово! Автоматически доступен в системе

### Добавление новой AI-модели
1. Создать файл `src/mapper/ask_new_model.py`
2. Реализовать функцию `ask_new_model(prompt, schema)`
3. Добавить в `mapper.py` логику выбора
4. Обновить UI для выбора модели

### Добавление предобработки
1. Добавить функцию в `preprocess_image.py`
2. Обновить `preprocess_image_config.yaml`
3. Вызвать в пайплайне обработки

---

## Процесс подготовки данных для обучения

```
parsing_files/ (JSON результаты)
    │
    ▼
┌─────────────────────────────────┐
│  xport_data.py                  │
│  1. Чтение всех JSON файлов     │
│  2. Чтение CSV из model_table   │
│  3. Создание Excel для каждого  │
│     JSON с листами:             │
│     - INPUT (из JSON)           │
│     - EXTENDED (из CSV)         │
│     - SIMPLIFIED (из CSV)       │
│  4. Автоподстройка ширины       │
│     столбцов (openpyxl)         │
└────────────┬────────────────────┘
             │
             ▼
   src/learning/datasets/
   (Excel файлы для обучения)
```

### Автоматическая подстройка ширины столбцов

Используется openpyxl для настройки ширины после создания Excel:

```python
# Загрузка файла
wb = load_workbook(excel_path)

# Для каждого столбца
for column in ws.columns:
    max_length = max(len(str(cell.value)) for cell in column)
    ws.column_dimensions[column_letter].width = min(max(max_length + 2, 10), 100)

# Сохранение
wb.save(excel_path)
```

**Параметры ширины:**
- Минимум: 10 символов
- Максимум: 100 символов
- Запас: +2 символа от максимальной длины

---

